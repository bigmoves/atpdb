#cloud-config

hostname: ${hostname}
manage_etc_hosts: true

package_update: true
package_upgrade: true
packages:
  - docker.io
  - docker-compose-v2
  - git
  - curl
  - htop
  - ncdu
  - jq
  - fail2ban
  - ufw
  - unattended-upgrades

users:
  - name: deploy
    groups: [docker, sudo]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys: []

write_files:
  # Docker daemon config
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "100m",
          "max-file": "3"
        }
      }

  # Environment file for docker compose
  - path: /opt/atpdb/.env
    permissions: '0644'
    owner: deploy:deploy
    content: |
      DOMAIN=${domain}
      GRAFANA_PASSWORD=${grafana_password}

  # atpdb systemd service
  - path: /etc/systemd/system/atpdb.service
    content: |
      [Unit]
      Description=ATPDB AT Protocol Indexer
      After=network.target

      [Service]
      Type=simple
      User=deploy
      WorkingDirectory=/data/atpdb
      ExecStart=/usr/local/bin/atpdb serve
      Environment=ATPDB_MODE=${atpdb_mode}
      Environment=ATPDB_RELAY=${atpdb_relay}
%{ if atpdb_signal_collection != "" ~}
      Environment=ATPDB_SIGNAL_COLLECTION=${atpdb_signal_collection}
%{ endif ~}
      Environment=ATPDB_COLLECTIONS=${atpdb_collections}
%{ if atpdb_indexes != "" ~}
      Environment=ATPDB_INDEXES=${atpdb_indexes}
%{ endif ~}
%{ if atpdb_search_fields != "" ~}
      Environment=ATPDB_SEARCH_FIELDS=${atpdb_search_fields}
%{ endif ~}
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Deploy script for updates
  - path: /usr/local/bin/atpdb-update
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      echo "Downloading latest atpdb..."
      curl -L -o /usr/local/bin/atpdb "https://github.com/${github_repo}/releases/download/latest/atpdb-linux-amd64"
      chmod +x /usr/local/bin/atpdb
      echo "Restarting atpdb..."
      systemctl restart atpdb
      echo "Done. Status:"
      systemctl status atpdb --no-pager

runcmd:
  # Copy SSH keys from root to deploy user
  - mkdir -p /home/deploy/.ssh
  - cp /root/.ssh/authorized_keys /home/deploy/.ssh/authorized_keys
  - chown -R deploy:deploy /home/deploy/.ssh
  - chmod 700 /home/deploy/.ssh
  - chmod 600 /home/deploy/.ssh/authorized_keys

  # Enable Docker
  - systemctl enable docker
  - systemctl start docker

  # Wait for docker to be ready
  - |
    for i in $(seq 1 30); do
      docker info >/dev/null 2>&1 && break
      sleep 2
    done

  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow http
  - ufw allow https
  # Allow Docker containers to reach host services (Caddy -> atpdb)
  - ufw allow from 172.16.0.0/12 to any port 3000
  - ufw --force enable

  # Create data directory and mount volume
  - mkdir -p /data/atpdb
  - |
    # Wait for volume to be attached
    for i in $(seq 1 30); do
      if [ -e /dev/disk/by-id/scsi-0HC_Volume_* ]; then
        break
      fi
      sleep 2
    done
  - |
    # Mount data volume
    DATA_DISK=$(ls -1 /dev/disk/by-id/scsi-0HC_Volume_* 2>/dev/null | head -1)
    if [ -n "$DATA_DISK" ]; then
      mount $DATA_DISK /data
      echo "$DATA_DISK /data ext4 defaults 0 2" >> /etc/fstab
    fi
  - mkdir -p /data/atpdb
  - chown -R deploy:deploy /data

  # Create application directory
  - mkdir -p /opt/atpdb
  - chown -R deploy:deploy /opt/atpdb

  # Download latest atpdb release
  - |
    echo "Downloading atpdb binary..."
    curl -fL -o /usr/local/bin/atpdb "https://github.com/${github_repo}/releases/download/latest/atpdb-linux-amd64"
    chmod +x /usr/local/bin/atpdb
    echo "Binary downloaded: $(ls -la /usr/local/bin/atpdb)"

  # Clone repo for docker configs (as deploy user)
  - sudo -u deploy git clone https://github.com/${github_repo}.git /opt/atpdb/repo

  # Copy env and set permissions
  - cp /opt/atpdb/.env /opt/atpdb/repo/infra/docker/.env
  - chown deploy:deploy /opt/atpdb/repo/infra/docker/.env

  # Start monitoring stack
  - |
    cd /opt/atpdb/repo/infra/docker
    sudo -u deploy docker compose up -d
    echo "Docker stack started"

  # Enable and start atpdb
  - systemctl daemon-reload
  - systemctl enable atpdb
  - systemctl start atpdb

  # Enable fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable automatic security updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades
